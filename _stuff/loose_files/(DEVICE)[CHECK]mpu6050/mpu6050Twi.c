/*
 * mpu6050Twi.c
 *
 * Created: 30/03/2018 23:11:43
 *  Author: Schwarz
 */

#include "mpu6050Twi.h"

#define MPU6050_SLAVE_ADDRESS		0x68

typedef enum mpu6050Register_t {
	MPU6050_SELF_TEST_X_REG			= 0x0D,
	MPU6050_SELF_TEST_Y_REG			= 0x0E,
	MPU6050_SELF_TEST_Z_REG			= 0x0F,
	MPU6050_SELF_TEST_A_REG			= 0x10,
	MPU6050_SMPLRT_DIV_REG			= 0x19,
	MPU6050_CONFIG_REG				= 0x1A,
	MPU6050_GYRO_CONFIG_REG			= 0x1B,
	MPU6050_ACCEL_CONFIG_REG		= 0x1C,
	MPU6050_FIFO_EN_REG				= 0x23,
	MPU6050_I2C_MST_CTRL_REG		= 0x24,
	MPU6050_I2C_SLV0_ADDR_REG		= 0x25,
	MPU6050_I2C_SLV0_REG			= 0x26,
	MPU6050_I2C_SLV0_CTRL_REG		= 0x27,
	MPU6050_I2C_SLV1_ADDR_REG		= 0x28,
	MPU6050_I2C_SLV1_REG			= 0x29,
	MPU6050_I2C_SLV1_CTRL_REG		= 0x2A,
	MPU6050_I2C_SLV2_ADDR_REG		= 0x2B,
	MPU6050_I2C_SLV2_REG			= 0x2C,
	MPU6050_I2C_SLV2_CTRL_REG		= 0x2D,
	MPU6050_I2C_SLV3_ADDR_REG		= 0x2E,
	MPU6050_I2C_SLV3_REG			= 0x2F,
	MPU6050_I2C_SLV3_CTRL_REG		= 0x30,
	MPU6050_I2C_SLV4_ADDR_REG		= 0x31,
	MPU6050_I2C_SLV4_REG			= 0x32,
	MPU6050_I2C_SLV4_DO_REG			= 0x33,
	MPU6050_I2C_SLV4_CTRL_REG		= 0x34,
	MPU6050_I2C_SLV4_DI_REG			= 0x35,
	MPU6050_I2C_MST_STATUS_REG		= 0x36,
	MPU6050_INT_PIN_CFG_REG			= 0x37,
	MPU6050_INT_ENABLE_REG			= 0x38,
	MPU6050_INT_STATUS_REG			= 0x3A,
	MPU6050_ACCEL_XOUT_H_REG		= 0x3B,
	MPU6050_ACCEL_XOUT_L_REG		= 0x3C,
	MPU6050_ACCEL_YOUT_H_REG		= 0x3D,
	MPU6050_ACCEL_YOUT_L_REG		= 0x3E,
	MPU6050_ACCEL_ZOUT_H_REG		= 0x3F,
	MPU6050_ACCEL_ZOUT_L_REG		= 0x40,
	MPU6050_TEMP_OUT_H_REG			= 0x41,
	MPU6050_TEMP_OUT_L_REG			= 0x42,
	MPU6050_GYRO_XOUT_H_REG			= 0x43,
	MPU6050_GYRO_XOUT_L_REG			= 0x44,
	MPU6050_GYRO_YOUT_H_REG			= 0x45,
	MPU6050_GYRO_YOUT_L_REG			= 0x46,
	MPU6050_GYRO_ZOUT_H_REG			= 0x47,
	MPU6050_GYRO_ZOUT_L_REG			= 0x48,
	MPU6050_EXT_SENS_DATA_00_REG	= 0x49,
	MPU6050_EXT_SENS_DATA_01_REG	= 0x4A,
	MPU6050_EXT_SENS_DATA_02_REG	= 0x4B,
	MPU6050_EXT_SENS_DATA_03_REG	= 0x4C,
	MPU6050_EXT_SENS_DATA_04_REG	= 0x4D,
	MPU6050_EXT_SENS_DATA_05_REG	= 0x4E,
	MPU6050_EXT_SENS_DATA_06_REG	= 0x4F,
	MPU6050_EXT_SENS_DATA_07_REG	= 0x50,
	MPU6050_EXT_SENS_DATA_08_REG	= 0x51,
	MPU6050_EXT_SENS_DATA_09_REG	= 0x52,
	MPU6050_EXT_SENS_DATA_10_REG	= 0x53,
	MPU6050_EXT_SENS_DATA_11_REG	= 0x54,
	MPU6050_EXT_SENS_DATA_12_REG	= 0x55,
	MPU6050_EXT_SENS_DATA_13_REG	= 0x56,
	MPU6050_EXT_SENS_DATA_14_REG	= 0x57,
	MPU6050_EXT_SENS_DATA_15_REG	= 0x58,
	MPU6050_EXT_SENS_DATA_16_REG	= 0x59,
	MPU6050_EXT_SENS_DATA_17_REG	= 0x5A,
	MPU6050_EXT_SENS_DATA_18_REG	= 0x5B,
	MPU6050_EXT_SENS_DATA_19_REG	= 0x5C,
	MPU6050_EXT_SENS_DATA_20_REG	= 0x5D,
	MPU6050_EXT_SENS_DATA_21_REG	= 0x5E,
	MPU6050_EXT_SENS_DATA_22_REG	= 0x5F,
	MPU6050_EXT_SENS_DATA_23_REG	= 0x60,
	MPU6050_I2C_SLV0_DO_REG			= 0x63,
	MPU6050_I2C_SLV1_DO_REG			= 0x64,
	MPU6050_I2C_SLV2_DO_REG			= 0x65,
	MPU6050_I2C_SLV3_DO_REG			= 0x66,
	MPU6050_I2C_MST_DELAY_CTRL_REG	= 0x67,
	MPU6050_SIGNAL_PATH_RESET_REG	= 0x68,
	MPU6050_USER_CTRL_REG			= 0x69,
	MPU6050_PWR_MGMT_1_REG			= 0x6A,
	MPU6050_PWR_MGMT_2_REG			= 0x6B,
	MPU6050_FIFO_COUNTH_REG			= 0x6C,
	MPU6050_FIFO_COUNTL_REG			= 0x72,
	MPU6050_FIFO_R_W_REG			= 0x74,
	MPU6050_WHO_AM_I_REG			= 0x75
} mpu6050Register_t;

typedef enum mpu6050Offset_t {
	MPU6050_XA_TEST_OFFSET			= 5,
	MPU6050_YA_TEST_OFFSET			= 5,
	MPU6050_ZA_TEST_OFFSET			= 5,
	MPU6050_XG_TEST_OFFSET			= 0,
	MPU6050_YG_TEST_OFFSET			= 0,
	MPU6050_ZG_TEST_OFFSET			= 0,
	MPU6050_XA_TEST_OFFSET			= 4,
	MPU6050_YA_TEST_OFFSET			= 2,
	MPU6050_ZA_TEST_OFFSET			= 0,
	MPU6050_EXT_SYNC_SET_OFFSET		= 3,
	MPU6050_DLPF_CFG_OFFSET			= 0,
	MPU6050_FS_SEL_OFFSET			= 3,
	MPU6050_AFS_SEL_OFFSET			= 3,
	MPU6050_I2C_MST_CLK_OFFSET		= 0,
	MPU6050_I2C_SLV0_ADDR_OFFSET	= 0,
	MPU6050_I2C_SLV0_REG_OFFSET		= 0,
	MPU6050_I2C_SLV0_LEN_OFFSET		= 0,
	MPU6050_I2C_SLV1_ADDR_OFFSET	= 0,
	MPU6050_I2C_SLV1_REG_OFFSET		= 0,
	MPU6050_I2C_SLV1_LEN_OFFSET		= 0,
	MPU6050_I2C_SLV2_ADDR_OFFSET	= 0,
	MPU6050_I2C_SLV2_REG_OFFSET		= 0,
	MPU6050_I2C_SLV2_LEN_OFFSET		= 0,
	MPU6050_I2C_SLV3_ADDR_OFFSET	= 0,
	MPU6050_I2C_SLV3_REG_OFFSET		= 0,
	MPU6050_I2C_SLV3_LEN_OFFSET		= 0,
	MPU6050_I2C_SLV4_ADDR_OFFSET	= 0,
	MPU6050_I2C_SLV4_REG_OFFSET		= 0,
	MPU6050_I2C_SLV4_DO_OFFSET		= 0,
	MPU6050_I2C_MST_DLY				= 0,
	MPU6050_I2C_SLV4_DI_OFFSET		= 0,
	MPU6050_CLKSEL_OFFSET			= 0,
	MPU6050_LP_WAKE_CTRL_OFFSET		= 6,
	MPU6050_WHO_AM_I_OFFSET			= 1
} mpu6050Offset_t;

typedef enum mpu6050Bit_t {
	MPU6050_XA_ST_BIT				= 7,
	MPU6050_YA_ST_BIT				= 6,
	MPU6050_ZA_ST_BIT				= 5,
	MPU6050_TEMP_FIFO_EN_BIT		= 7,
	MPU6050_XG_FIFO_EN_BIT			= 6,
	MPU6050_YG_FIFO_EN_BIT			= 5,
	MPU6050_ZG_FIFO_EN_BIT			= 4,
	MPU6050_ACCEL_FIFO_EN_BIT		= 3,
	MPU6050_SLV2_FIFO_EN_BIT		= 2,
	MPU6050_SLV1_FIFO_EN_BIT		= 1,
	MPU6050_SLV0_FIFO_EN_BIT		= 0,
	MPU6050_MULT_MST_EN_BIT			= 7,
	MPU6050_WAIT_FOR_ES_BIT			= 6,
	MPU6050_SLV_3_FIFO_EN_BIT		= 5,
	MPU6050_MST_P_NSR_BIT			= 4,
	MPU6050_I2C_SLV0_RW_BIT			= 7,
	MPU6050_I2C_SLV0_EN_BIT			= 7,
	MPU6050_I2C_SLV0_BYTE_SW_BIT	= 6,
	MPU6050_I2C_SLV0_REG_DIS_BIT	= 5,
	MPU6050_I2C_SLV0_GRP_BIT		= 4,
	MPU6050_I2C_SLV1_RW_BIT			= 7,
	MPU6050_I2C_SLV1_EN_BIT			= 7,
	MPU6050_I2C_SLV1_BYTE_SW_BIT	= 6,
	MPU6050_I2C_SLV1_REG_DIS_BIT	= 5,
	MPU6050_I2C_SLV1_GRP_BIT		= 4,
	MPU6050_I2C_SLV2_RW_BIT			= 7,
	MPU6050_I2C_SLV2_EN_BIT			= 7,
	MPU6050_I2C_SLV2_BYTE_SW_BIT	= 6,
	MPU6050_I2C_SLV2_REG_DIS_BIT	= 5,
	MPU6050_I2C_SLV2_GRP_BIT		= 4,
	MPU6050_I2C_SLV3_RW_BIT			= 7,
	MPU6050_I2C_SLV3_EN_BIT			= 7,
	MPU6050_I2C_SLV3_BYTE_SW_BIT	= 6,
	MPU6050_I2C_SLV3_REG_DIS_BIT	= 5,
	MPU6050_I2C_SLV3_GRP_BIT		= 4,
	MPU6050_I2C_SLV4_RW_BIT			= 7,
	MPU6050_I2C_SLV4_EN_BIT			= 7,
	MPU6050_I2C_SLV4_INT_EN_BIT		= 6,
	MPU6050_I2C_SLV4_REG_DIS_BIT	= 5,
	MPU6050_PASS_THROUGH_BIT		= 7,
	MPU6050_I2C_SLV4_DONE_BIT		= 6,
	MPU6050_I2C_LOST_ARB_BIT		= 5,
	MPU6050_I2C_SLV4_NACK_BIT		= 4,
	MPU6050_I2C_SLV3_NACK_BIT		= 3,
	MPU6050_I2C_SLV2_NACK_BIT		= 2,
	MPU6050_I2C_SLV1_NACK_BIT		= 1,
	MPU6050_I2C_SLV0_NACK_BIT		= 0,
	MPU6050_INT_LEVEL_BIT			= 7,
	MPU6050_INT_OPEN_BIT			= 6,
	MPU6050_LATCH_INT_EN_BIT		= 5,
	MPU6050_INT_RD_CLEAR_BIT		= 4,
	MPU6050_FSYNC_INT_LEVEL_BIT		= 3,
	MPU6050_FSYNC_INT_EN_BIT		= 2,
	MPU6050_I2C_BYPASS_EN_BIT		= 1,
	MPU6050_FIFO_OFLOW_EN_BIT		= 4,
	MPU6050_I2C_MST_INT_EN_BIT		= 3,
	MPU6050_DATA_RDY_EN_BIT			= 0,
	MPU6050_FIFO_OFLOW_INT_BIT		= 4,
	MPU6050_I2C_MST_INT_INT_BIT		= 3,
	MPU6050_DATA_RDY_INT_BIT		= 0,
	MPU6050_DELAY_ES_SHADOW_BIT		= 7,
	MPU6050_I2C_SLV4_DLY_EN_BIT		= 4,
	MPU6050_I2C_SLV3_DLY_EN_BIT		= 3,
	MPU6050_I2C_SLV2_DLY_EN_BIT		= 2,
	MPU6050_I2C_SLV1_DLY_EN_BIT		= 1,
	MPU6050_I2C_SLV0_DLY_EN_BIT		= 0,
	MPU6050_GYRO_RESET_BIT			= 2,
	MPU6050_ACCEL_RESET_BIT			= 1,
	MPU6050_TEMP_RESET_BIT			= 0,
	MPU6050_FIFO_EN_BIT				= 6,
	MPU6050_I2C_MST_EN_BIT			= 5,
	MPU6050_I2C_IF_DIS_BIT			= 4,
	MPU6050_FIFO_RESET_BIT			= 2,
	MPU6050_I2C_MST_RESET_BIT		= 1,
	MPU6050_SIG_COND_RESET_BIT		= 0,
	MPU6050_DEVICE_RESET_BIT		= 7,
	MPU6050_SLEEP_BIT				= 6,
	MPU6050_CYCLE_BIT				= 5,
	MPU6050_TEMP_DIS_BIT			= 3,
	MPU6050_STBY_XA_BIT				= 5,
	MPU6050_STBY_YA_BIT				= 4,
	MPU6050_STBY_ZA_BIT				= 3,
	MPU6050_STBY_XG_BIT				= 2,
	MPU6050_STBY_YG_BIT				= 1,
	MPU6050_STBY_ZG_BIT				= 0
} mpu6050Bit_t;


void mpu6050AccConfig(mpu6050AccScale_t scale)
{
	uint8_t buffer[2];

	buffer[0] = MPU6050_ACCEL_CONFIG_REG;
	buffer[1] = scale << MPU6050_AFS_SEL_OFFSET;
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_WRITE, buffer, 2);

	return;
}

void mpu6050GyrConfig(mpu6050GyrScale_t scale)
{
	uint8_t buffer[2];

	buffer[0] = MPU6050_GYRO_CONFIG_REG;
	buffer[1] = scale << MPU6050_FS_SEL_OFFSET;
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_WRITE, buffer, 2);

	return;
}

void mpu6050FIFOOverflowInterrupt(bool_t enabled)
{
	uint8_t buffer[2];

	buffer[0] = MPU6050_INT_ENABLE_REG;
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_WRITE, buffer, 1);
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_READ, buffer, 1);
	buffer[1] = buffer[0];
	buffer[0] = MPU6050_INT_ENABLE_REG;
	if(enabled) {
		setBit(buffer[1], MPU6050_FIFO_OFLOW_EN_BIT);
	} else {
		clrBit(buffer[1], MPU6050_FIFO_OFLOW_EN_BIT);
	}
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_WRITE, buffer, 2);

	return;
}

void mpu6050I2CMasterInterrupt(bool_t enabled)
{
	uint8_t buffer[2];

	buffer[0] = MPU6050_INT_ENABLE_REG;
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_WRITE, buffer, 1);
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_READ, buffer, 1);
	buffer[1] = buffer[0];
	buffer[0] = MPU6050_INT_ENABLE_REG;
	if(enabled) {
		setBit(buffer[1], MPU6050_I2C_MST_INT_EN_BIT);
	} else {
		clrBit(buffer[1], MPU6050_I2C_MST_INT_EN_BIT);
	}
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_WRITE, buffer, 2);

	return;
}

void mpu6050DataReadyInterrupt(bool_t enabled);
{
	uint8_t buffer[2];

	buffer[0] = MPU6050_INT_ENABLE_REG;
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_WRITE, buffer, 1);
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_READ, buffer, 1);
	buffer[1] = buffer[0];
	buffer[0] = MPU6050_INT_ENABLE_REG;
	if(enabled) {
		setBit(buffer[1], MPU6050_DATA_RDY_EN_BIT);
	} else {
		clrBit(buffer[1], MPU6050_DATA_RDY_EN_BIT);
	}
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_WRITE, buffer, 2);

	return;
}

void mpu6050InterruptStatus(bool_t enabled)
{
	uint8_t buffer;

	buffer = MPU6050_INT_STATUS_REG;
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_WRITE, &buffer, 1);
	twiMasterSendData(MPU6050_SLAVE_ADDRESS, TWI_READ, &buffer, 1);

	return buffer;
}

